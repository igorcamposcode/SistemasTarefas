<!-- Cabeçalho da Página -->
<header class="page-header">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <img
      class="page-header-title"
      src="/assets/system-task-logo.jpg.png"
      alt="Sistemas de Tarefas"
    />

    <!-- Botões de Ações -->
    <div class="top-actions d-flex justify-content-end gap-3 mb-3">
      <button
        class="btn btn btn-dark btn-sm"
        (click)="abrirModalUsuario()"
        style="
          font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande',
            'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
          padding: 20px;
          font-size: 1rem;
        "
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-house-door"
          viewBox="0 0 17 17"
        >
          <path
            d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4z"
          />
        </svg>
        Usuário: {{ usuario.length > 0 ? usuario[0].nome : 'Carregando...' }}
      </button>
      <button
        class="btn btn-dark btn-sm"
        (click)="Clique_Retornar('home')"
        style="
          font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande',
            'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
          padding: 20px;
          font-size: 1rem;
        "
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-arrow-return-left"
          viewBox="0 0 16 16"
        >
          <path
            fill-rule="evenodd"
            d="M14.5 1.5a.5.5 0 0 1 .5.5v4.8a2.5 2.5 0 0 1-2.5 2.5H2.707l3.347 3.346a.5.5 0 0 1-.708.708l-4.2-4.2a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 8.3H12.5A1.5 1.5 0 0 0 14 6.8V2a.5.5 0 0 1 .5-.5"
          />
        </svg>
        Retornar
      </button>
      <button
        class="btn btn-danger btn-sm"
        (click)="CliqueHome('login')"
        style="
          font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande',
            'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
          padding: 20px;
          font-size: 1rem;
        "
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-door-closed"
          viewBox="0 0 16 16"
        >
          <path
            d="M3 2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v13h1.5a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1H3zm1 13h8V2H4z"
          />
          <path d="M9 9a1 1 0 1 0 2 0 1 1 0 0 0-2 0" />
        </svg>
        Sair
      </button>
    </div>

    <!-- Modal para Exibir Dados do Usuário -->
    <div
      class="modal fade"
      id="usuarioModal"
      tabindex="-1"
      aria-labelledby="usuarioModalLabel"
      aria-hidden="true"
      [class.show]="isUsuarioModalVisible"
      [style.display]="isUsuarioModalVisible ? 'block' : 'none'"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="usuarioModalLabel">Dados do Usuário</h5>
            <button
              type="button"
              class="btn-close"
              aria-label="Fechar"
              (click)="fecharModalUsuario()"
            ></button>
          </div>
          <div class="modal-body user-data-modal-body">
            <p><strong>Nome:</strong> {{ usuario.length > 0 ? usuario[0].nome : 'N/A' }}</p>
            <p><strong>Telefone:</strong> {{ usuario.length > 0 ? usuario[0].telefone : 'N/A' }}</p>
            <p><strong>Email:</strong> {{ usuario.length > 0 ? usuario[0].email : 'N/A' }}</p>
            <button
              class="btn btn-primary mt-3"
              (click)="abrirModalEditarUsuario()"
            >
              Alterar Dados do Usuário
            </button>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="fecharModalUsuario()"
            >
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
<!-- Modal para Exibir Dados do Usuário -->
<div
  class="modal fade"
  id="usuarioModal"
  tabindex="-1"
  aria-labelledby="usuarioModalLabel"
  aria-hidden="true"
  [class.show]="isUsuarioModalVisible"
  [style.display]="isUsuarioModalVisible ? 'block' : 'none'"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="usuarioModalLabel">Dados do Usuário</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Fechar"
          (click)="fecharModalUsuario()"
        ></button>
      </div>
      <div
          class="modal-body"
          style="
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande',
              'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
            font-size: 1rem;
          "
        >
          <p><strong>Nome:</strong> {{ usuario.length > 0 ? usuario[0].nome : 'N/A' }}</p>
          <p><strong>Telefone:</strong> {{ usuario.length > 0 ? usuario[0].telefone : 'N/A' }}</p>
          <p><strong>Email:</strong> {{ usuario.length > 0 ? usuario[0].email : 'N/A' }}</p>
          <button
            class="btn btn-primary mt-3"
            (click)="abrirModalEditarUsuario()"
          >
            Alterar Dados do Usuário
          </button>
        </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="fecharModalUsuario()"
        >
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Editar Dados do Usuário -->
<div
  class="modal fade"
  id="editarUsuarioModal"
  tabindex="-1"
  aria-labelledby="editarUsuarioModalLabel"
  aria-hidden="true"
  [class.show]="isEditarUsuarioModalVisible"
  [style.display]="isEditarUsuarioModalVisible ? 'block' : 'none'"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editarUsuarioModalLabel">
          Alterar Dados do Usuário
        </h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Fechar"
          (click)="fecharModalEditarUsuario()"
        ></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="usuarioForm">
          <!-- Nome -->
          <div class="mb-3">
            <label for="nome" class="form-label">Nome</label>
            <input
              id="nome"
              type="text"
              class="form-control"
              formControlName="nome"
              placeholder="Digite seu nome"
            />
          </div>
          <!-- Telefone -->
          <div class="mb-3">
            <label for="telefone" class="form-label">Telefone</label>
            <input
              id="telefone"
              type="text"
              class="form-control"
              formControlName="telefone"
              placeholder="Digite seu telefone"
            />
          </div>
          <!-- Email -->
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input
              id="email"
              type="email"
              class="form-control"
              formControlName="email"
              placeholder="Digite seu email"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="fecharModalEditarUsuario()"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="salvarDadosUsuario()"
        >
          Salvar Alterações
        </button>
      </div>
    </div>
  </div>
</div>
<div>
  <div>
    <!--https://ng.ant.design/components/table/en-->
    <nz-table
      #nzTable
      [nzData]="listOfDisplayData"
      nzTableLayout="fixed"
      class="ConsultaTarefa"
      [nzLoading]="loading"
      [nzScroll]="{ x: '1200px' }"
    >
      <thead>
        <tr style="text-align: center; font-weight: bold">
          <th nzCustomFilter style="width: 300px">
            NOME DA TAREFA
            <nz-filter-trigger
              [(nzVisible)]="visible"
              [nzActive]="searchValue.length > 0"
              [nzDropdownMenu]="menu"
            >
              <span nz-icon nzType="search"></span>
            </nz-filter-trigger>
          </th>
          <th style="width: 65px">ID</th>
          <th style="width: 190px">USUÁRIO RESPONSÁVEL</th>
          <th style="width: 120px">TIPO</th>
          <th style="width: 135px">ESTADO DA TAREFA</th>
          <th style="width: 135px">PRIORIDADE</th>
          <th style="width: 200px">DATA & HORA INÍCIO</th>
          <th style="width: 200px">DATA & HORA FIM</th>
          <th style="width: 400px">SUB TAREFAS</th>
        </tr>
      </thead>
      <tbody>
        @for (data of nzTable.data; track data) {
        <tr>
          <td>
            <strong>{{ data.titulo }}</strong>
            @if (data.descricao) {
            <br /><small style="color: #666">{{ data.descricao }}</small>
            }
          </td>
          <td>{{ data.id }}</td>
          <td>{{ data.UsuarioResponsavel }}</td>
          <td>
            @if (data.idmae) {
            <nz-tag nzColor="blue">Sub Tarefa</nz-tag>
            <br /><small>ID Mãe: {{ data.idmae }}</small>
            } @else {
            <nz-tag nzColor="green">Tarefa Principal</nz-tag>
            }
          </td>
          <td>
            <nz-tag [nzColor]="obterCorEstado(data.EstadoAtual?.nome || '')">
              {{ data.EstadoAtual?.nome || "Não definido" }}
            </nz-tag>
          </td>
          <td>
            <nz-tag nzColor="purple">{{
              data.Prioridade?.nome || "Não definida"
            }}</nz-tag>
          </td>
          <td>{{ formatarData(data.dthrinicio) }}</td>
          <td>{{ formatarData(data.dthrfim) }}</td>
          <td>
            @if (data.SubTarefas && data.SubTarefas.length > 0) {
            <nz-collapse>
              <nz-collapse-panel
                [nzHeader]="'Ver ' + data.SubTarefas.length + ' subtarefa(s)'"
                [nzActive]="false"
              >
                <div style="max-height: 300px; overflow-y: auto">
                  @for (subtarefa of data.SubTarefas; track subtarefa) {
                  <div
                    style="
                      border: 1px solid #d9d9d9;
                      margin: 8px 0;
                      padding: 12px;
                      border-radius: 6px;
                    "
                  >
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                      "
                    >
                      <strong>{{ subtarefa.titulo }}</strong>
                      <span style="font-size: 12px; color: #ff0000"
                        >ID: {{ subtarefa.id }}</span
                      >
                    </div>
                    <div
                      style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 8px;
                        font-size: 12px;
                      "
                    >
                      <div>
                        <strong>Estado:</strong>
                        <nz-tag
                          [nzColor]="
                            obterCorEstado(subtarefa.EstadoAtual?.nome || '')
                          "
                          style="margin-left: 4px"
                        >
                          {{ subtarefa.EstadoAtual?.nome || "Não definido" }}
                        </nz-tag>
                      </div>
                      <div>
                        <strong>Prioridade:</strong>
                        <nz-tag nzColor="purple" style="margin-left: 4px">
                          {{ subtarefa.Prioridade?.nome || "Não definida" }}
                        </nz-tag>
                      </div>
                      <div>
                        <strong>Início:</strong>
                        {{ formatarData(subtarefa.dthrinicio) }}
                      </div>
                      <div>
                        <strong>Fim:</strong>
                        {{ formatarData(subtarefa.dthrfim) }}
                      </div>
                    </div>
                  </div>
                  }
                </div>
              </nz-collapse-panel>
            </nz-collapse>
            } @else {
            <span style="color: #999">Nenhuma subtarefa</span>
            }
          </td>
        </tr>
        }
      </tbody>
    </nz-table>

    <nz-dropdown-menu #menu="nzDropdownMenu">
      <div class="ant-table-filter-dropdown">
        <div class="search-box">
          <input
            type="text"
            nz-input
            placeholder="Pesquisar por Tarefa ou Usuário"
            [(ngModel)]="searchValue"
          />
          <button (click)="search()" class="search-button">Pesquisar</button>
          <button class="reset-button" (click)="reset()">Resetar</button>
        </div>
      </div>
    </nz-dropdown-menu>
  </div>
</div>
